<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>Pitch Difference Task</title>

        <link href="lib/jsPsych-master/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    
        <!-- Button scaling based on viewport size -->
        <style>
            .imgbutton {
                width: 30vw;
                max-width: 30vh;
                height: auto;
            }
            
            .instruc {
                width: 50vw;
            } /* formatting for instructions text */
            
            .trialtext {
                width: 25vw;
                position: fixed;
                text-align: left;
                left: 15vw;
                top: 25vh;
                font-size:38px;
            } /* formatting for trial/feedback text */
            
            .nextbutton {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 150px;
            }
            .nextbutton:hover {
                border: 1px solid #777;
            } /* formatting of the next button */
            
            body {
                background-color: #B0C4DE;
            }
            /* background color of the window */
        </style>
    </head>

    <body>

        <!-- Functions for data mgmt, math, and sound generation -->
        <script src="lib/data_mgmt.js" type="text/javascript"></script>
        <script src="lib/math_helpers.js" type="text/javascript"></script>
        <script src="lib/sound_functions_pd.js" type="text/javascript"></script>

        <!-- jsPsych plug-ins -->
        <script src="lib/jsPsych-master/jspsych.js"></script>
        <script src="lib/jsPsych-master/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="lib/jsPsych-master/plugins/jspsych-html-button-response.js"></script>
    

        <!-- Main -->
        <script>
            //Create timeline
            var timeline = [];

            //Create array to store data for each trial as a JSON object
            var trial_data = [];

            //Number of trials
            var ntrials    = 100; 

            //trials_type = higher or lower. 0 for higher, 1 for lower
            var trials_type = jsPsych.randomization.repeat([0,1],ntrials/2); 
            
            // setting the pitch diff
            var diff;
            var diff1 = 1; // starting diff for staircase 1
            var diff2 = 7; // starting diff for staircase 2
            
            // staircase tracking
            var staircase = [];
            for (var i=0;i<=48;i++) {
                staircase.push(0);
                staircase.push(1);
            } // create an array of repeating 0's and 1's
            //staircase = [staircase,staircase];
            var staircase_track0 = 0;
            var staircase_track1 = 0;
            
            var MinFreq = 300;
            var MaxFreq = 2000;
            
            var gap_dur = 1; // 1 sec between the tones

            //Track current block and trial
            //var cur_block = 0;
            var cur_trial = 0;

            //Tracks whether the participant is ready to proceed past the examples
            var loop_again;

            //Other global variables
            var cur_type = NaN;         //Track current stim type (easier than constantly indexing trials_type)
            var last_correct = false;   //Track correctness of latest response
            var total_correct = 0;      //Track total number of correct responses
            var trial_obj;              //Track the parameters of the latest stimulus
            
            // Start Screen (instructions)
            var start_screen = {
                type: 'html-button-response',
                stimulus: '<div class="instruc"><p><b>Welcome to the PITCH DIFFERENCE TASK!</b></p><p>You will listen to tones and judge if they are higher or lower in pitch from each other.</p><p>Please put on your headphones and click <b>NEXT</b> to listen to some examples of these stimuli.</p></div>',
                choices: ['next.png'],
                button_html: '<img src="%choice%" class="nextbutton"/>'
            }
            timeline.push(start_screen);
            
            // Example 1
            var nExample = 0; // counter to keep track of num examples played
            var demoNoteDiff = [3,9];
            var example1 = {
                type: 'html-button-response',
                stimulus: '',
                prompt: '<p>Here is an example of a <b>HIGHER</b> pitched second tone.</p><p>Click <b>NEXT</b> to continue.</p>',
                choices: ['next.png'],
                button_html: '<img src="%choice%" class="nextbutton"/>',
                on_start: function(example1){
                    //play_tones(diff, high_or_low, MinFreq, MaxFreq)
                    play_tones(demoNoteDiff[nExample%2],0,MinFreq,MaxFreq,gap_dur);      
                }
            }

            // Example 2
            var example2 = {
                type: 'html-button-response',
                stimulus: '',
                prompt: '<p>Here is an example of a <b>LOWER</b> pitched second tone.</p><p>Click <b>NEXT</b> to continue.</p>',
                choices: ['next.png'],
                button_html: '<img src="%choice%" class="nextbutton"/>',
                on_start: function(example2){
                    //play_tones(diff, high_or_low, MinFreq, MaxFreq)
                    play_tones(demoNoteDiff[nExample%2],1,MinFreq,MaxFreq,gap_dur);   
                    nExample++;
                }
            }

            // sets up the looping of the examples
            var example_loop = {
                timeline: [example1, example2],
                loop_function: function() {
                    return nExample<2; // as long as this returns TRUE, keep repeating
                }
            }
            timeline.push(example_loop);

            // Final screen before beginning the experiment; reminds instructions
            var example_wrap = {
                type: 'html-button-response',
                stimulus: '<div class="instruc"><p><b>READY?</b></p><p>To recap, you will listen to 100 pairs of pitches. You will be asked if the 2nd pitch in each pair was HIGHER or LOWER than the 1st pitch in the pair. You will receive feedback for each response.</p><p>Please put your headphones on now before beginning and try your best!</p><p>Click <b>NEXT</b> to begin.</p></div>',
                choices: ['next.png'],
                button_html: '<img src="%choice%" class="nextbutton"/>' 
            }
            timeline.push(example_wrap);

            
            //Playback screen
            var playback = {
                type: "html-keyboard-response",
                stimulus: "",
                choices: ['q'],
                trial_duration: 2*500+gap_dur*1000,
                on_start: function(playback) {
                    
                    // Set diff based on which staircase we are on
                    diff = staircase[cur_trial] == 0? diff1:diff2;
                    
                    //High or low?
                    cur_type = trials_type[cur_trial];

                    //Play the specified stim and hold onto its specs
                    //play_tones(diff, high_or_low, MinFreq, MaxFreq)
                    trial_obj = play_tones(diff,cur_type,MinFreq,MaxFreq,gap_dur);

                },
                on_finish: function(data){
                    if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press)=='q'){ // option to skip for testing purposes
                            //NaN because no answer provided on this trial
                            trial_resp = NaN;
                        
                            //Skip the current timeline (i.e., go to next level)
                            jsPsych.endCurrentTimeline();
                        }
                    
                }
            }

            //Trial screen
            var trial = {
                type: "html-button-response",
                stimulus: "Error! This text should not appear to the user!",
                choices: ['',''],
                on_start: function(trial) {
                    //Set up text for this trial
                    let tag = "<p>Was the 2nd pitch HIGHER or LOWER than the 1st pitch?</p>";
                    trial.stimulus = ("<p><b>Trial ").concat([cur_trial+1].toString()).concat(" of ").concat(ntrials.toString()).concat("</b></p>").concat(tag);
                    
                    trial.choices = ['Higher','Lower'];   
                    
                },
                on_finish: function(data) {
                    //Check correctness to provide feedback
                    let trial_resp = data.button_pressed;                                  
                                        
                    //Update globals so feedback screen is accurate; update staircase
                    if(trial_resp == cur_type) { // if correct response
                        last_correct = true;
                        total_correct++;
                        
                        // tally a correct response for the staircase
                        if(staircase[cur_trial] == 0){ // staircase 0
                            staircase_track0++;
                            if(cur_trial>3 && staircase_track0 > 2){
                                // If there have been 3 trials with staircase 0, then cur_trial must be >=4.
                                // Adjust diff if 3 correct in a row for this staircase
                                diff1 = 0.9*diff;
                            } else{
                                diff1 = diff/0.9; // if <3 trials or last 3 not correct
                            }                            
                        }
                        else { // staircase 1
                            staircase_track1++;
                            if(cur_trial>4 && staircase_track1 > 2){
                                // If there have been 3 trials with staircase 1, then cur_trial must be >=5.
                                // Adjust diff if 3 correct in a row for this staircase
                                diff2 = 0.7*diff;
                            } else{
                                diff2 = diff/0.7; // if <3 trials or last 3 not correct
                            }
                        }
                    } else {
                        last_correct = false;
                        
                        // reset the staircase if incorrect response
                        if(staircase[cur_trial] == 0){
                            staircase_track0 = 0;
                            diff1 = diff/0.9;
                        }
                        else {
                            staircase_track1 = 0;
                            diff2 = diff/0.7;
                        }
                    }
                    
                    if(diff>24){ // 2 octaves
                        diff = 24;
                    }
                                        
                    //Append the trial parameters and results to the data array
                    trial_data = trial_data.concat({
                        
                        cur_trial: cur_trial+1,
                        higher_or_lower: cur_type,
                        freq1: trial_obj.freq1,
                        freq2: trial_obj.freq2,
                        correct_answer: cur_type,
                        response: trial_resp,
                        correct: cur_type==trial_resp,
                        staircase: staircase[cur_trial],
                        staircase_track0: staircase[cur_trial]==0? staircase_track0:NaN,
                        staircase_track1: staircase[cur_trial]==0? NaN:staircase_track1,
                        diff: diff                        
                    });
                }
            }

            //Feedback screen
            var feedback = {
                type: "html-button-response",
                stimulus: "Error! This text should not appear!",
                choices: [],
                trial_duration: 700,
                post_trial_gap: 150,
                on_start: function(feedback){
                    //Stop stim if it's still going (should be redundant due to playback trial duration)
                    stop_stim();
                    if (last_correct){
                        feedback.stimulus = "<p style='color:green'><b>CORRECT</b></p>"
                    }else{
                        feedback.stimulus = "<p style='color:red'><b>INCORRECT</b></p>"
                    }
                },
                on_finish: function(feedback){
                    cur_trial++;
                }
            }

            //Block timeline
            var block_timeline = {
                timeline: [playback, trial, feedback],
                repetitions: 100
            }
            timeline.push(block_timeline);
            

            //Thank you page
            var end_screen = {
                type: "html-keyboard-response",
                stimulus: '',
                choices: [],
                on_start: function(end_screen) {
                    end_screen.stimulus = ('<p>You have finished this task. Yay!</p><p>Percent correct = ').concat(((total_correct/cur_trial)*100).toFixed(2)).concat('%</p><p><a href="https://bigspeechexperiment.web.app/">Return to the main screen</a></p>');
                    
                    //Save data locally as csv. Source: https://github.com/mholt/PapaParse/issues/175
                    var blob = new Blob([ConvertToCSV(trial_data)]);
                    if (window.navigator.msSaveOrOpenBlob)  // IE hack; see http://msdn.microsoft.com/en-us/library/ie/hh779016.aspx
                        window.navigator.msSaveBlob(blob, "data_pitchdiff.csv");
                    else
                    {
                        var a = window.document.createElement("a");
                        a.href = window.URL.createObjectURL(blob, {type: "text/plain"});
                        a.download = "data_pitchdiff.csv";
                        document.body.appendChild(a);
                        a.click();  // IE: "Access is denied"; see: https://connect.microsoft.com/IE/feedback/details/797361/ie-10-treats-blob-url-as-cross-origin-and-denies-access
                        document.body.removeChild(a);
                    }
                }
            }
            timeline.push(end_screen);  

            //Execute experiment logic specified above
            jsPsych.init({
                timeline: timeline
            });

        </script>
    </body>
</html>
